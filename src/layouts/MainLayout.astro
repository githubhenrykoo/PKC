---
// MainLayout.astro
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PKC</title>
  
  <!-- Runtime environment variables -->
  <script is:inline>
    // Initialize RUNTIME_ENV as empty object
    window.RUNTIME_ENV = window.RUNTIME_ENV || {};
    
    console.log("Initial environment variables:", window.RUNTIME_ENV);
  </script>
  
  <!-- Load runtime environment variables - Enhanced for production -->
  <script>
    // Function to load environment variables
    function loadRuntimeEnv() {
      console.log('ðŸ”„ Loading runtime environment variables...');
      
      fetch('/runtime-env.js', {
        method: 'GET',
        cache: 'no-store', // Prevent caching issues in production
        headers: {
          'Cache-Control': 'no-cache'
        }
      })
      .then(response => {
        console.log('ðŸ“¡ Runtime env response status:', response.status);
        if (response.ok) {
          return response.text();
        }
        throw new Error(`Runtime env endpoint returned ${response.status}`);
      })
      .then(script => {
        console.log('ðŸ“œ Runtime env script received:', script.substring(0, 100) + '...');
        // Execute the script to set window.RUNTIME_ENV
        eval(script);
        console.log('âœ… Runtime environment variables loaded successfully:', window.RUNTIME_ENV);
        
        // Dispatch a custom event to notify other scripts that env is ready
        window.dispatchEvent(new CustomEvent('runtime-env-loaded', { 
          detail: window.RUNTIME_ENV 
        }));
      })
      .catch(error => {
        console.error('âŒ Failed to load runtime environment variables:', error);
        console.log('Current RUNTIME_ENV state:', window.RUNTIME_ENV);
        
        // Fallback: try to use any existing RUNTIME_ENV
        if (window.RUNTIME_ENV && Object.keys(window.RUNTIME_ENV).length > 0) {
          console.log('ðŸ”„ Using existing RUNTIME_ENV as fallback');
          window.dispatchEvent(new CustomEvent('runtime-env-loaded', { 
            detail: window.RUNTIME_ENV 
          }));
        }
      });
    }
    
    // Load immediately and also when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadRuntimeEnv);
    } else {
      loadRuntimeEnv();
    }
  </script>
  
  <!-- Simple Redux Alternative - Direct State Management -->
  <script is:inline>
    // Simple state management without Redux dependency
    console.log('ðŸ”„ Initializing simple state management...');
    
    // Create a simple store alternative
    const simpleStore = {
      state: {
        mcardSelection: {
          hash: null,
          title: null,
          gTime: null,
          contentType: null
        }
      },
      listeners: [],
      subscribe: function(listener) {
        this.listeners.push(listener);
        return () => {
          const index = this.listeners.indexOf(listener);
          if (index > -1) this.listeners.splice(index, 1);
        };
      },
      dispatch: function(action) {
        console.log('ðŸ“¡ Dispatching action:', action);
        if (action.type === 'mcardSelection/setSelectedMCard') {
          this.state.mcardSelection = {
            hash: action.payload.hash,
            title: action.payload.title,
            gTime: action.payload.gTime || null,
            contentType: action.payload.contentType || null
          };
          console.log('ðŸ“Š Updated state:', this.state);
          this.listeners.forEach(listener => listener());
        } else if (action.type === 'mcardSelection/clearSelectedMCard') {
          this.state.mcardSelection = {
            hash: null,
            title: null,
            gTime: null,
            contentType: null
          };
          this.listeners.forEach(listener => listener());
        }
      },
      getState: function() {
        return this.state;
      }
    };
    
    // Expose to window
    window.reduxStore = simpleStore;
    
    console.log('âœ… Simple Redux store initialized and attached to window');
    console.log('ðŸ“Š Initial state:', simpleStore.getState());
    
    // Dispatch ready event
    document.addEventListener('DOMContentLoaded', () => {
      window.dispatchEvent(new CustomEvent('redux-store-ready'));
      console.log('ðŸš€ Redux store ready event dispatched');
    });
  </script>
  
  <!-- Slot for head content from child layouts -->
  <slot name="head"/>
</head>
<body>
  <slot />
</body>
</html>
