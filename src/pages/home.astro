---
import AppShell from "../layouts/AppShell.astro";
import Topbar from "../components/layout/topbar.astro";
import NavigationSidebar from "../components/layout/functional/navigation_sidebar.astro";
import RightPanel from "../components/layout/right-panel.astro";
import Footer from "../components/layout/footer.astro";
import DynamicContentViewer from "../components/layout/functional/dynamic-content-viewer.astro";
---

<AppShell title="Epistemic Athenæum" enableThemeToggle={false}>
  <Topbar slot="header" title="Epistemic Athenæum" />
  <NavigationSidebar slot="sidebar" />
  <RightPanel slot="right" />
  <Footer slot="footer" />

  <DynamicContentViewer
    initialTitle="Epistemic Athenæum"
  />
</AppShell>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Auto-load Google Calendar when the home page loads
    const contentTitle = document.getElementById('content-title');
    const contentType = document.getElementById('content-type');
    const contentTimestamp = document.getElementById('content-timestamp');
    const placeholder = document.getElementById('content-placeholder');
    const rendererSlot = document.getElementById('renderer-slot');

    if (!contentTitle || !rendererSlot) return;

    // Update header
    contentTitle.innerHTML = `
      <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
      </svg>
      Google Calendar
    `;

    if (contentType) contentType.textContent = 'Google Calendar Integration';
    if (contentTimestamp) contentTimestamp.textContent = new Date().toLocaleString();

    // Hide placeholder and show renderer slot
    if (placeholder) placeholder.classList.add('hidden');
    rendererSlot.classList.remove('hidden');

    // Load the actual Google Calendar React component
    loadGoogleCalendarComponent(rendererSlot);
  });

  /**
   * Loads and renders the Google Calendar component
   * @param {HTMLElement} rendererSlot - The DOM element where the component will be rendered
   */
  async function loadGoogleCalendarComponent(rendererSlot) {
    try {
      // Import React and create root
      const React = await import('react');
      const { createRoot } = await import('react-dom/client');
      const { default: GoogleCalendar } = await import('../components/googlecalendar/googlecalendar.jsx');

      // Create container for the React component
      rendererSlot.innerHTML = `<div id="google-calendar-container" class="h-full w-full"></div>`;
      const container = document.getElementById('google-calendar-container');

      if (container) {
        // Create React root and render Google Calendar component
        const root = createRoot(container);
        root.render(React.createElement(GoogleCalendar, {
          className: 'h-full'
        }));
      }
    } catch (error) {
      console.error('Failed to load Google Calendar component:', error);
      rendererSlot.innerHTML = `
        <div class="h-full flex items-center justify-center">
          <div class="text-center p-8">
            <div class="text-red-500 text-4xl mb-4">⚠️</div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Failed to Load Google Calendar</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4">Unable to initialize the Google Calendar interface.</p>
            <p class="text-sm text-gray-500 dark:text-gray-500">Error: ${error instanceof Error ? error.message : 'Unknown error'}</p>
          </div>
        </div>
      `;
    }
  }
</script>